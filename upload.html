<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canary - ì—…ë¡œë“œ</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="loadingModal">
      <div class="modal-content">
        <div id="loadingText">ë¶„ì„ ì¤‘...</div>
      </div>
    </div>
    <div class="container">
      <div class="back-button" onclick="window.history.back();">
        &lt; &nbsp; ë’¤ë¡œê°€ê¸°
      </div>
      <h3 id="category-title"></h3>
      <span id="info">ì›í•˜ì‹œëŠ” ì œí’ˆ ì •ë³´ê°€ ë‹´ê¸´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</span>
      <span id="info">(ìµœëŒ€ 10ì¥, ìš©ëŸ‰ 10MB ë¯¸ë§Œ ì¤€ìˆ˜)</span>
      <div class="image-container">
        <label for="file-upload" class="file-upload"> + </label>
        <input id="file-upload" type="file" multiple accept="image/*" />
        <div id="image-preview" class="image-preview"></div>
      </div>
      <button id="uploadButton">ë¶„ì„í•˜ê¸°</button>
      <hr />
      <div id="response"></div>
    </div>
    <script>
      /* ì¹´í…Œê³ ë¦¬ íŒŒë¼ë¯¸í„° ê°’ ì½ê¸° */
      function getParameterByName(name) {
        const url = window.location.href;
        const nameWithEqual = name + "=";
        const start = url.indexOf(nameWithEqual);

        if (start === -1) return null;

        const end = url.indexOf("&", start);

        return decodeURIComponent(
          url.substring(
            start + nameWithEqual.length,
            end === -1 ? url.length : end
          )
        );
      }

      // íŒŒë¼ë¯¸í„° ê°’ ì½ê¸°
      const paramValue = getParameterByName("category");
      console.log(paramValue);

      let title =
        paramValue === "cosmetic"
          ? "ğŸ§´ í™”ì¥í’ˆ"
          : paramValue === "electric"
          ? "âš¡ ì „ê¸°ì œí’ˆ"
          : paramValue === "child"
          ? "ğŸ§’ ì•„ë™ì œí’ˆ"
          : paramValue === "infant"
          ? "ğŸ‘¶ğŸ» ìœ ì•„ì œí’ˆ"
          : "";

      document.getElementById("category-title").innerText =
        title + " í‘œì‹œì‚¬í•­ ì˜¤ë¥˜ ì ê²€";

      /* í”„ë¦¬ë¡œë” ì„¤ì • */
      const messages = ["ë¶„ì„ ì¤‘", "ë¶„ì„ ì¤‘.", "ë¶„ì„ ì¤‘..", "ë¶„ì„ ì¤‘..."];
      let index = 0;
      const textInterval = setInterval(() => {
        loadingText.textContent = messages[index];
        index = (index + 1) % messages.length;
      }, 500);

      /* ì—…ë¡œë“œ ë²„íŠ¼ ëˆ„ë¥´ê³  API í˜¸ì¶œ */
      document
        .getElementById("uploadButton")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("file-upload");
          const file = fileInput.files[0];

          if (!file) {
            alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          loadingModal.style.display = "flex";

          const responseDiv = document.getElementById("response");
          const innerDivs = responseDiv.querySelectorAll("div");
          innerDivs.forEach((innerDiv) => innerDiv.remove());

          const myHeaders = new Headers();
          myHeaders.append(
            "x-api-key",
            "1wTctbDP0p2MHf3J664eu4OEHxMCNmhj4IOAbdUV"
          );
          myHeaders.append("Content-Type", "application/jpg");

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: file,
            redirect: "follow",
          };

          fetch(
            "https://gwud4lb2g8.execute-api.ap-northeast-2.amazonaws.com/dev/?category=" +
              paramValue,
            requestOptions
          )
            .then((response) => response.text())
            .then((result) => getResult(result))
            .catch((error) => alert("ì˜¤ë¥˜\n\n" + error))
            .finally(() => clearInterval(textInterval));
        });

      /* ì‘ë‹µ ê²°ê³¼ ì¶œë ¥ */
      function getResult(resultString) {
        loadingModal.style.display = "none";

        const result = JSON.parse(resultString);
        const bodyString = result.body;
        const body = JSON.parse(bodyString);

        const mandatories = body.mandatories;
        const outputContainer = document.getElementById("response");

        let itemMap = [];

        for (let i = 0; i < Object.keys(mandatories).length; i++) {
          const item = mandatories[`${i}`];

          const label = `${JSON.stringify(item.label)}`.replace(/"/g, "");
          const content = `${JSON.stringify(item.content)}`.replace(/"/g, "");
          const insufficient = `${JSON.stringify(item.insufficient)}`.replace(
            /"/g,
            ""
          );

          itemMap.push({
            key: JSON.stringify(item.status),
            value: createItem(
              JSON.stringify(item.status),
              label,
              content,
              insufficient
            ),
          });
        }

        // ë¶€ì¡± > ëˆ„ë½ > ì •ìƒ ìˆœìœ¼ë¡œ ì •ë ¬
        itemMap.sort((a, b) => b.key - a.key);

        const container = document.querySelector("#response");
        itemMap.forEach((item) => {
          container.appendChild(item.value);
        });
      }

      /* ëˆ„ë½/ë¶€ì¡± ì»´í¬ë„ŒíŠ¸ í´ë¦­ ì´ë²¤íŠ¸ */
      function toggleInsufficient(element) {
        const contentInfo = element.querySelector(".item-content");
        const insufficientInfo = element.querySelector(".item-insufficient");
        if (
          insufficientInfo.style.display === "none" ||
          insufficientInfo.style.display === ""
        ) {
          contentInfo.style.display = "block"; // ë‚´ìš© í‘œì‹œ
          insufficientInfo.style.display = "block"; // ë‚´ìš© í‘œì‹œ
        } else {
          contentInfo.style.display = "none"; // ë‚´ìš© ìˆ¨ê¹€
          insufficientInfo.style.display = "none"; // ë‚´ìš© ìˆ¨ê¹€
        }
      }

      /* ì»´í¬ë„ŒíŠ¸ ìƒì„± */
      function createItem(status, label, content, insufficient) {
        // item ìš”ì†Œ ìƒì„±
        const item = document.createElement("div");
        item.className = "item";

        //if (status == "2") {
        item.onclick = function () {
          toggleInsufficient(this);
        };
        //}

        // ì²« ë²ˆì§¸ item-row ìƒì„±
        const itemRow1 = document.createElement("div");
        itemRow1.className = "item-row";

        let className = "";

        if (status == "0") {
          status = "ì •ìƒ";
          className = "normal";
        } else if (status == "1") {
          status = "ëˆ„ë½";
          className = "missing";
        } else {
          status = "ë¶€ì¡±";
          className = "error";
        }

        // ìƒíƒœ span ìƒì„±
        const statusSpan = document.createElement("span");
        statusSpan.className = `item-status ${className}`;
        statusSpan.innerText = status;

        // ì œí’ˆëª… span ìƒì„±
        const labelSpan = document.createElement("span");
        labelSpan.className = "item-label";
        labelSpan.innerText = label;

        // ì²« ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow1.appendChild(statusSpan);
        itemRow1.appendChild(labelSpan);
        item.appendChild(itemRow1);

        // ë‘ ë²ˆì§¸ item-row ìƒì„±
        const itemRow2 = document.createElement("div");
        itemRow2.className = "item-row";

        // ë‚´ìš© span ìƒì„±
        const contentSpan = document.createElement("span");
        contentSpan.className = "item-content";
        contentSpan.innerText = content;

        // ë‘ ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow2.appendChild(contentSpan);
        item.appendChild(itemRow2);

        // ì„¸ ë²ˆì§¸ item-row ìƒì„±
        const itemRow3 = document.createElement("div");
        itemRow3.className = "item-row";

        // ë¶€ì¡± span ìƒì„±
        const insufficientSpan = document.createElement("span");
        insufficientSpan.className = "item-insufficient";
        insufficientSpan.innerText = insufficient;

        // ì„¸ ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow3.appendChild(insufficientSpan);
        item.appendChild(itemRow3);

        // ìµœì¢…ì ìœ¼ë¡œ ìƒì„±ëœ itemì„ ë°˜í™˜
        return item;
      }
    </script>
    <script>
      document
        .getElementById("file-upload")
        .addEventListener("change", function (event) {
          const files = event.target.files;
          const imagePreview = document.getElementById("image-preview");

          Array.from(files).forEach((file) => {
            if (file) {
              const maxSize = 10 * 1024 * 1024;
              if (file.size >= maxSize) {
                alert("10MB ë¯¸ë§Œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
              }
            }

            const reader = new FileReader();

            reader.onload = function (e) {
              const img = document.createElement("img");
              img.src = e.target.result;

              const button = document.createElement("button");
              button.innerHTML = "Ã—";
              button.onclick = function () {
                img.remove();
                button.remove();
              };

              const wrapper = document.createElement("div");
              wrapper.style.position = "relative";
              wrapper.appendChild(img);
              wrapper.appendChild(button);
              imagePreview.appendChild(wrapper);
            };

            reader.readAsDataURL(file);
          });
        });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canary - ì—…ë¡œë“œ</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="loadingModal">
      <div class="modal-content">
        <div id="loadingText"></div>
      </div>
    </div>
    <div class="container">
      <div class="back-button" onclick="window.history.back();">
        &lt; &nbsp; ë’¤ë¡œê°€ê¸°
      </div>
      <h3 id="category-title"></h3>
      <span id="info">ì œí’ˆ ì •ë³´ê°€ ë‹´ê¸´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</span>
      <span id="info">(1ì¥ë§Œ, ìš©ëŸ‰ 10MB ë¯¸ë§Œ ì¤€ìˆ˜)</span>
      <div class="image-container">
        <label for="file-upload" class="file-upload"> + </label>
        <input id="file-upload" type="file" multiple accept="image/*" />
        <div id="image-preview" class="image-preview"></div>
      </div>
      <button id="uploadButton">ì˜¤ë¥˜ ì ê²€</button>
      <hr />
      <div id="result">
        <span>ê²°ê³¼ : </span>
        <span id="product"></span>
        <span id="answer"></span>
        <span id="kcno"></span>
      </div>
      <div id="response"></div>
    </div>
    <script>
      /* ì¹´í…Œê³ ë¦¬ íŒŒë¼ë¯¸í„° ê°’ ì½ê¸° */
      function getParameterByName(name) {
        const url = window.location.href;
        const nameWithEqual = name + "=";
        const start = url.indexOf(nameWithEqual);

        if (start === -1) return null;

        const end = url.indexOf("&", start);

        return decodeURIComponent(
          url.substring(
            start + nameWithEqual.length,
            end === -1 ? url.length : end
          )
        );
      }

      // íŒŒë¼ë¯¸í„° ê°’ ì½ê¸°
      const paramValue = getParameterByName("category");
      console.log(paramValue);

      let title =
        paramValue === "cosmetic"
          ? "ğŸ§´ í™”ì¥í’ˆ"
          : paramValue === "chemicals"
          ? "ğŸ§ª ìƒí™œí™”í•™ì œí’ˆ"
          : paramValue === "child"
          ? "ğŸ§’ ì•„ë™ì œí’ˆ"
          : paramValue === "infant"
          ? "ğŸ‘¶ğŸ» ìœ ì•„ì œí’ˆ"
          : "";

      document.getElementById("category-title").innerText =
        title + " í‘œì‹œì‚¬í•­ ì˜¤ë¥˜ ì ê²€";

      /* í”„ë¦¬ë¡œë” ì„¤ì • */
      const messages = ["ë¶„ì„ ì¤‘", "ë¶„ì„ ì¤‘.", "ë¶„ì„ ì¤‘..", "ë¶„ì„ ì¤‘..."];
      let index = 0;
      const textInterval = setInterval(() => {
        loadingText.textContent = messages[index];
        index = (index + 1) % messages.length;
      }, 500);

      /* ì—…ë¡œë“œ ë²„íŠ¼ ëˆ„ë¥´ê³  API í˜¸ì¶œ */
      document
        .getElementById("uploadButton")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("file-upload");
          const file = fileInput.files[0];

          const base64Image = "";

          if (file) {
            const reader = new FileReader();

            reader.onloadend = function () {
              base64Image = reader.result;
              console.log(base64Image); // Base64 ì¸ì½”ë”©ëœ ë¬¸ìì—´
            };

            reader.readAsDataURL(file); // íŒŒì¼ì„ Data URLë¡œ ì½ê¸°
          } else {
            alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          // Preloader í‘œì‹œ
          loadingModal.style.display = "flex";

          // ê²°ê³¼ í™”ë©´ 1 ì´ˆê¸°í™”
          const resultDiv = document.getElementById("result");
          resultDiv.querySelector("#product").innerText = "";
          resultDiv.querySelector("#answer").innerText = "";
          resultDiv.querySelector("#kcno").innerText = "";

          // ê²°ê³¼ í™”ë©´ 2 ì´ˆê¸°í™”
          const responseDiv = document.getElementById("response");
          const innerDivs = responseDiv.querySelectorAll("div");
          innerDivs.forEach((innerDiv) => innerDiv.remove());

          const classifications =
            responseDiv.querySelectorAll(".classification");
          classifications.forEach((classification) => classification.remove());

          const hrs = responseDiv.querySelectorAll("hr");
          hrs.forEach((hr) => hr.remove());

          const myHeaders = new Headers();
          myHeaders.append(
            "x-api-key",
            "1wTctbDP0p2MHf3J664eu4OEHxMCNmhj4IOAbdUV"
          );

          const fileType = file.name.split(".").pop();
          console.log("UPLOAD IMAGE TYPE" + fileType);

          myHeaders.append("Content-Type", "image/" + fileType);

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: base64Image,
            redirect: "follow",
          };

          fetch(
            "https://gwud4lb2g8.execute-api.ap-northeast-2.amazonaws.com/dev?category=" +
              paramValue,
            requestOptions
          )
            .then((response) => response.text())
            .then((result) => getResult(result))
            .catch((error) => alert("ì˜¤ë¥˜\n\n" + error))
            .finally(() => clearInterval(textInterval));
        });

      /* ì‘ë‹µ ê²°ê³¼ ì¶œë ¥ */
      function getResult(resultString) {
        loadingModal.style.display = "none";

        const result = JSON.parse(resultString);

        console.log(result);

        const bodyString = result.body;
        const body = JSON.parse(bodyString);

        // product, answer, kcno ì²˜ë¦¬
        document.querySelector("#product").innerText = body.product + " | ";
        document.querySelector("#answer").innerText =
          body.answer == "true" ? "ì í•©" : "ë¶€ì í•©";
        if (getParameterByName("category") != "cosmetic") {
          document.querySelector("#kcno").innerText = JSON.stringify(
            JSON.parse(result.kcno).content
          ).replace(/"/g, "");

          const status = JSON.stringify(JSON.parse(result.kcno).status).replace(
            /"/g,
            ""
          );

          if (status == "0")
            document.querySelector("#kcno").style =
              "color: green; text-decoration: underline;";
          else
            document.querySelector("#kcno").style =
              "color: red; text-decoration: underline;";
        }

        // í•„ìˆ˜ ìš”ì†Œ ì²˜ë¦¬
        const mandatories = body.mandatories;

        let itemMap = [];

        for (let i = 0; i < Object.keys(mandatories).length; i++) {
          const item = mandatories[`${i}`];

          const label = `${JSON.stringify(item.label)}`.replace(/"/g, "");
          const content = `${JSON.stringify(item.content)}`.replace(/"/g, "");
          const insufficient = `${JSON.stringify(item.insufficient)}`.replace(
            /"/g,
            ""
          );

          itemMap.push({
            key: JSON.parse(item.status),
            value: createItem(
              JSON.parse(item.status),
              label,
              content,
              insufficient
            ),
          });
        }

        // ëˆ„ë½ > ë¶€ì¡± > ì •ìƒ ìˆœìœ¼ë¡œ ì •ë ¬
        itemMap.sort((a, b) => b.key - a.key);

        const container = document.querySelector("#response");
        let prevKey = null;

        itemMap.forEach((item) => {
          // keyê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ h3 íƒœê·¸ ì¶”ê°€
          if (item.key !== prevKey) {
            const titleText =
              item.key == "0"
                ? "ì •ìƒ"
                : item.key == "1"
                ? "ë¶€ì¡±"
                : item.key == "2"
                ? "ëˆ„ë½"
                : "";
            const id =
              item.key == "0"
                ? "normal"
                : item.key == "1"
                ? "error"
                : item.key == "2"
                ? "missing"
                : "";

            const h3 = document.createElement("h3");
            h3.className = "classification";
            h3.id = id;
            h3.textContent = titleText;
            container.appendChild(h3);

            const hr = document.createElement("hr");
            hr.style = "width: 100%;";
            container.appendChild(hr);

            // ì´ì „ key ì—…ë°ì´íŠ¸
            prevKey = item.key;
          }

          container.appendChild(item.value);
        });
      }

      /* ì»´í¬ë„ŒíŠ¸ ìƒì„± */
      function createItem(status, label, content, insufficient) {
        // item ìš”ì†Œ ìƒì„±
        const item = document.createElement("div");
        item.className = "item";

        let className = "";

        if (status == 0) {
          status = "ì •ìƒ";
          className = "normal";
        } else if (status == 1) {
          status = "ë¶€ì¡±";
          className = "error";
        } else if (status == 2) {
          status = "ëˆ„ë½";
          className = "missing";
        } else {
          console.log(status);
        }

        // ì²« ë²ˆì§¸ item-row ìƒì„±
        const itemRow1 = document.createElement("div");
        itemRow1.className = "item-row";

        // ìƒíƒœ span ìƒì„±
        const statusSpan = document.createElement("span");
        statusSpan.className = `item-status ${className}`;
        statusSpan.innerText = status;

        // ì œí’ˆëª… span ìƒì„±
        const labelSpan = document.createElement("span");
        labelSpan.className = "item-label";
        labelSpan.innerText = label;

        // ì²« ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow1.appendChild(statusSpan);
        itemRow1.appendChild(labelSpan);
        item.appendChild(itemRow1);

        // ë‘ ë²ˆì§¸ item-row ìƒì„±
        const itemRow2 = document.createElement("div");
        itemRow2.className = "item-row";

        // ë‚´ìš© span ìƒì„±
        const contentSpan = document.createElement("span");
        contentSpan.className = "item-content";
        contentSpan.innerText = content;

        // ë‘ ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow2.appendChild(contentSpan);
        item.appendChild(itemRow2);

        // ì„¸ ë²ˆì§¸ item-row ìƒì„±
        const itemRow3 = document.createElement("div");
        itemRow3.className = "item-row";

        // ë¶€ì¡± span ìƒì„±
        const insufficientSpan = document.createElement("span");
        insufficientSpan.className = "item-insufficient";
        insufficientSpan.innerText = insufficient;

        // ì„¸ ë²ˆì§¸ item-rowì— ìš”ì†Œ ì¶”ê°€
        itemRow3.appendChild(insufficientSpan);
        item.appendChild(itemRow3);

        // ìµœì¢…ì ìœ¼ë¡œ ìƒì„±ëœ itemì„ ë°˜í™˜
        return item;
      }
    </script>
    <script>
      document
        .getElementById("file-upload")
        .addEventListener("change", function (event) {
          const files = event.target.files;
          const imagePreview = document.getElementById("image-preview");

          Array.from(files).forEach((file) => {
            if (file) {
              const maxSize = 10 * 1024 * 1024;
              if (file.size >= maxSize) {
                alert("10MB ë¯¸ë§Œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
              }
            }

            const reader = new FileReader();

            reader.onload = function (e) {
              const img = document.createElement("img");
              img.src = e.target.result;

              const button = document.createElement("button");
              button.innerHTML = "Ã—";
              button.onclick = function () {
                img.remove();
                button.remove();
              };

              const wrapper = document.createElement("div");
              wrapper.style.position = "relative";
              wrapper.appendChild(img);
              wrapper.appendChild(button);
              imagePreview.appendChild(wrapper);
            };

            reader.readAsDataURL(file);
          });
        });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Canary - 업로드</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>이미지 업로드</h1>
      <input type="file" id="fileInput" accept="image/*" multiple />
      <button id="uploadButton">업로드</button>
      <hr />
      <div id="response"></div>
    </div>
    <script>
      /* 업로드 버튼 누르고 API 호출 */
      document
        .getElementById("uploadButton")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("fileInput");
          const file = fileInput.files[0];

          if (!file) {
            alert("이미지를 선택해주세요.");
            return;
          }

          const responseDiv = document.getElementById("response");
          const innerDivs = responseDiv.querySelectorAll("div");
          innerDivs.forEach((innerDiv) => innerDiv.remove());

          const myHeaders = new Headers();
          myHeaders.append(
            "x-api-key",
            "1wTctbDP0p2MHf3J664eu4OEHxMCNmhj4IOAbdUV"
          );
          myHeaders.append("Content-Type", "application/jpg");

          const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: file,
            redirect: "follow",
          };

          fetch(
            "https://gwud4lb2g8.execute-api.ap-northeast-2.amazonaws.com/dev/",
            requestOptions
          )
            .then((response) => response.text())
            .then((result) => getResult(result))
            .catch((error) => alert("오류\n\n" + error));
        });

      function getResult(resultString) {
        const result = JSON.parse(resultString);
        const bodyString = result.body;
        const body = JSON.parse(bodyString);

        const mandatories = body.mandatories;
        const outputContainer = document.getElementById("response");

        let itemMap = [];

        for (let i = 0; i < Object.keys(mandatories).length; i++) {
          const item = mandatories[`${i}`];

          const label = `${JSON.stringify(item.label)}`.replace(/"/g, "");
          const content = `${JSON.stringify(item.content)}`.replace(/"/g, "");
          const insufficient = `${JSON.stringify(item.insufficient)}`.replace(
            /"/g,
            ""
          );

          itemMap.push({
            key: JSON.stringify(item.status),
            value: createItem(
              JSON.stringify(item.status),
              label,
              content,
              insufficient
            ),
          });
        }

        // 부족 > 누락 > 정상 순으로 정렬
        itemMap.sort((a, b) => b.key - a.key);

        const container = document.querySelector("#response");
        itemMap.forEach((item) => {
          container.appendChild(item.value);
        });
      }
    </script>

    <script>
      function toggleInsufficient(element) {
        const contentInfo = element.querySelector(".item-content");
        const insufficientInfo = element.querySelector(".item-insufficient");
        if (
          insufficientInfo.style.display === "none" ||
          insufficientInfo.style.display === ""
        ) {
          contentInfo.style.display = "block"; // 내용 표시
          insufficientInfo.style.display = "block"; // 내용 표시
        } else {
          contentInfo.style.display = "none"; // 내용 숨김
          insufficientInfo.style.display = "none"; // 내용 숨김
        }
      }

      function createItem(status, label, content, insufficient) {
        // item 요소 생성
        const item = document.createElement("div");
        item.className = "item";

        if (status == "2") {
          item.onclick = function () {
            toggleInsufficient(this);
          };
        }

        // 첫 번째 item-row 생성
        const itemRow1 = document.createElement("div");
        itemRow1.className = "item-row";

        let className = "";

        if (status == "0") {
          status = "정상";
          className = "normal";
        } else if (status == "1") {
          status = "누락";
          className = "missing";
        } else {
          status = "부족";
          className = "error";
        }

        // 상태 span 생성
        const statusSpan = document.createElement("span");
        statusSpan.className = `item-status ${className}`;
        statusSpan.innerText = status;

        // 제품명 span 생성
        const labelSpan = document.createElement("span");
        labelSpan.className = "item-label";
        labelSpan.innerText = label;

        // 첫 번째 item-row에 요소 추가
        itemRow1.appendChild(statusSpan);
        itemRow1.appendChild(labelSpan);
        item.appendChild(itemRow1);

        // 두 번째 item-row 생성
        const itemRow2 = document.createElement("div");
        itemRow2.className = "item-row";

        // 내용 span 생성
        const contentSpan = document.createElement("span");
        contentSpan.className = "item-content";
        contentSpan.innerText = content;

        // 두 번째 item-row에 요소 추가
        itemRow2.appendChild(contentSpan);
        item.appendChild(itemRow2);

        // 세 번째 item-row 생성
        const itemRow3 = document.createElement("div");
        itemRow3.className = "item-row";

        // 부족 span 생성
        const insufficientSpan = document.createElement("span");
        insufficientSpan.className = "item-insufficient";
        insufficientSpan.innerText = insufficient;

        // 세 번째 item-row에 요소 추가
        itemRow3.appendChild(insufficientSpan);
        item.appendChild(itemRow3);

        // 최종적으로 생성된 item을 반환
        return item;
      }
    </script>
  </body>
</html>
